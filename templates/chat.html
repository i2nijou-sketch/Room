<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OODaiPèŠå¤©å®¤ - æˆ¿é—´</title>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    .emoji-btn { background:#ffc13b; color:#202020; }
    .sys { color:#888; text-align:center; }
    .quick-bar { display:flex; flex-wrap:wrap; gap:6px; margin:8px 0; }
    .quick-bar .btn-small { padding:6px 10px; border:1px solid #d9dfe6; border-radius:8px; background:#eef3ff; color:#2f56c3; cursor:pointer; }
    .quick-bar .btn-small:hover { background:#e3e9ff; }
    
    /* AI èŠå¤©æ ·å¼ */
    .ai-chat-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 16px;
      margin: 10px 0;
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .ai-chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: bold;
    }
    .ai-name {
      font-size: 16px;
    }
    .ai-status {
      font-size: 14px;
      opacity: 0.8;
    }
    .ai-chat-content {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: 8px;
      min-height: 40px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    /* æ‰“å­—åŠ¨ç”» */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
    }
    .typing-indicator span {
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background-color: white;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="room-title">OODaiP èŠå¤©å®¤</div>
      <div class="actions">
        <button id="historyBtn" class="btn" title="å†å²è®°å½•">å†å²è®°å½•</button>
        <button id="logoutBtn" class="btn" title="é€€å‡º">é€€å‡º</button>
      </div>
    </div>

    <div class="main">
      <aside class="sidebar">
        <div class="user-list">
          <div>åœ¨çº¿æˆå‘˜</div>
          <div class="list" id="userList"></div>
        </div>
      </aside>

      <section class="chat">
        <div class="messages" id="messages"></div>
        <div class="input-area">
          <div class="quick-bar">
            <button id="cmdCheng" class="btn-small">@æˆå°ç†</button>
            <button id="cmdMusic" class="btn-small">@éŸ³ä¹ä¸€ä¸‹</button>
            <button id="cmdMovie" class="btn-small">@ç”µå½±</button>
            <button id="cmdWeather" class="btn-small">@å¤©æ°”</button>
            <button id="cmdNews" class="btn-small">@æ–°é—»</button>
            <button id="cmdShort" class="btn-small">@å°è§†é¢‘</button>
          </div>
          <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæ”¯æŒ @åŠŸèƒ½ä¸ emoji ğŸ˜€"></textarea>
          <button id="emojiBtn" class="btn emoji-btn">ğŸ˜€</button>
          <button id="sendBtn" class="btn">å‘é€</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    const nickname = "{{ escape(nickname) }}";
    const wsUrl = "{{ escape(ws_url) }}";
    const isHttpsPage = window.location.protocol === 'https:';
    // åªç”¨ http/wsï¼šå¦‚æœå½“å‰é¡µé¢æ˜¯ httpsï¼Œæ˜ç¡®æç¤ºç”¨æˆ·æ”¹ç”¨ http é¡µé¢è®¿é—®
    if (isHttpsPage && wsUrl.startsWith('ws://')) {
      console.warn('[WS] å½“å‰é¡µé¢ä¸º HTTPSï¼Œws:// å°†è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œè¯·æ”¹ç”¨ http é¡µé¢è®¿é—®');
    }

    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const historyBtn = document.getElementById('historyBtn');
    // å¿«æ· @ åŠŸèƒ½æŒ‰é’®
    const cmdCheng = document.getElementById('cmdCheng');
    const cmdMusic = document.getElementById('cmdMusic');
    const cmdMovie = document.getElementById('cmdMovie');
    const cmdWeather = document.getElementById('cmdWeather');
    const cmdNews = document.getElementById('cmdNews');
    const cmdShort = document.getElementById('cmdShort');

    // Socket
    let ws;
    function connect() {
      const connectUrl = wsUrl; // æŒ‰é…ç½®ç›´è¿ï¼Œä¸åšåè®®è‡ªåŠ¨å‡çº§/é™çº§
      addSystem('æ­£åœ¨è¿æ¥ï¼š' + connectUrl);
      console.log('[WS] page:', window.location.href, 'protocol:', window.location.protocol, 'connectUrl:', connectUrl);
      // å¦‚æœæ˜¯ https é¡µé¢ä¸” connectUrl æ˜¯ ws://ï¼Œæµè§ˆå™¨ä¼šæŠ¥é”™ï¼Œè¿™é‡Œä»…æç¤º
      if (isHttpsPage && connectUrl.startsWith('ws://')) {
        addSystem('å½“å‰é¡µé¢ä¸º HTTPSï¼Œä¸èƒ½è¿æ¥ ws://ï¼Œè¯·ä½¿ç”¨ http é¡µé¢è®¿é—®');
      }
      ws = new WebSocket(connectUrl);
      ws.addEventListener('open', () => {
        addSystem('å·²è¿æ¥æœåŠ¡å™¨');
      });
      ws.addEventListener('message', (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if(msg.type === 'system') {
            addSystem(msg.text);
          } else if(msg.type === 'chat') {
            addMessage(msg.nickname, msg.text, msg.time, msg.is_safe_html);
          }
        } catch(e) {
          addMessage('æœªçŸ¥', evt.data);
        }
      });
      ws.addEventListener('close', (evt) => {
        addSystem('è¿æ¥å·²å…³é—­');
        console.warn('[WS] closed code:', evt && evt.code, 'reason:', evt && evt.reason);
      });
      ws.addEventListener('error', (evt) => {
        addSystem('è¿æ¥é”™è¯¯');
        console.error('[WS] error event:', evt);
      });
    }
    connect();

    // UI helpers
    function addSystem(text){
      const div = document.createElement('div');
      div.className = 'message sys';
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function addMessage(user, text, time, isSafeHtml = false){
      const wrap = document.createElement('div');
      wrap.className = 'message';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = user + 'ï¼š';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if (isSafeHtml) {
        bubble.innerHTML = text;
      } else {
        bubble.textContent = text;
      }
      wrap.appendChild(meta);
      wrap.appendChild(bubble);
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // å¤„ç† AI èŠå¤©å®¹å™¨çš„ SSE è¿æ¥
    function handleAIChatContainers() {
      // æŸ¥æ‰¾æ‰€æœ‰æœªå¤„ç†çš„ AI èŠå¤©å®¹å™¨
      const containers = document.querySelectorAll('.ai-chat-container:not([data-processed])');
      
      containers.forEach(container => {
        // æ ‡è®°ä¸ºå·²å¤„ç†
        container.setAttribute('data-processed', 'true');
        
        const contentDiv = container.querySelector('.ai-chat-content');
        const question = contentDiv.getAttribute('data-question');
        const containerId = contentDiv.id;
        
        // å»ºç«‹ SSE è¿æ¥
        const url = '/ai/stream?prompt=' + encodeURIComponent(question);
        const es = new EventSource(url);
        
        // æ¸…é™¤æ‰“å­—åŠ¨ç”»
        let currentContent = '';
        
        es.onmessage = (e) => {
          const data = e.data;
          
          if (data === '[DONE]') {
            es.close();
            // æ›´æ–°çŠ¶æ€
            container.querySelector('.ai-status').textContent = 'å·²å®Œæˆ';
            return;
          }
          
          // å¤„ç†é”™è¯¯æ¶ˆæ¯
          if (data.startsWith('[Error]')) {
            contentDiv.innerHTML = `<div class="ai-error">${data}</div>`;
            container.querySelector('.ai-status').textContent = 'å‘ç”Ÿé”™è¯¯';
            es.close();
            return;
          }
          
          // è¿½åŠ å†…å®¹
          currentContent += data;
          // ç§»é™¤æ‰“å­—åŠ¨ç”»å¹¶æ˜¾ç¤ºå®é™…å†…å®¹
          contentDiv.innerHTML = `<div class="ai-answer">${currentContent}</div>`;
          messagesEl.scrollTop = messagesEl.scrollHeight;
        };
        
        es.addEventListener('error', (e) => {
          // å¤„ç†è¿æ¥é”™è¯¯
          if (es.readyState === EventSource.CLOSED) return;
          
          contentDiv.innerHTML = '<div class="ai-error">è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•</div>';
          container.querySelector('.ai-status').textContent = 'è¿æ¥é”™è¯¯';
          es.close();
        });
      });
    }
    
    // ç›‘å¬æ¶ˆæ¯åŒºåŸŸå˜åŒ–ï¼Œå½“æœ‰æ–°æ¶ˆæ¯æ·»åŠ æ—¶å¤„ç† AI èŠå¤©å®¹å™¨
    const observer = new MutationObserver(() => {
      handleAIChatContainers();
    });
    
    observer.observe(messagesEl, {
      childList: true,
      subtree: true
    });

    // Send
    function send(){
      const text = inputEl.value.trim();
      if(!text){ return; }

      // ç»Ÿä¸€èµ° WebSocket å¹¿æ’­ï¼ŒAI è§¦å‘é€»è¾‘ç§»è‡³ onmessage
      if(ws && ws.readyState === 1){
        ws.send(JSON.stringify({ nickname, text }));
        inputEl.value = '';
      }
    }
    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    // ç»‘å®šå¿«æ· @ åŠŸèƒ½è¡Œä¸º
    cmdCheng.addEventListener('click', ()=>{
      inputEl.value = '@æˆå°ç† ';
      inputEl.focus();
    });
    cmdMusic.addEventListener('click', ()=>{
      inputEl.value = '@éŸ³ä¹ä¸€ä¸‹';
      send();
    });
    cmdMovie.addEventListener('click', ()=>{
      const url = prompt('è¯·è¾“å…¥è§†é¢‘é“¾æ¥ï¼ˆä¾‹å¦‚ https://v.qq.com/...ï¼‰');
      if(!url){ return; }
      inputEl.value = '@ç”µå½± ' + url;
      send();
    });
    cmdWeather.addEventListener('click', ()=>{
      inputEl.value = '@å¤©æ°”';
      send();
    });
    cmdNews.addEventListener('click', ()=>{
      inputEl.value = '@æ–°é—»';
      send();
    });
    cmdShort.addEventListener('click', ()=>{
      inputEl.value = '@å°è§†é¢‘';
      send();
    });

    // Emoji
    emojiBtn.addEventListener('click', ()=>{
      inputEl.value += ' ğŸ˜€';
      inputEl.focus();
    });

    // å†å²è®°å½•å ä½
    historyBtn.addEventListener('click', ()=>{
      alert('å†å²è®°å½•åŠŸèƒ½æ­£åœ¨å»ºè®¾ä¸­ï½');
    });

    // é€€å‡º
    logoutBtn.addEventListener('click', ()=>{
      try{ ws.close(); }catch(e){}
      window.location.href = '/';
    });
  </script>
</body>
</html>
